# Changelog

## v2.31.0 (2025-12-17) - ⚡ 性能与代码质量优化

### 性能优化

- **修复 N+1 查询** - `media.py` 回退查询改为批量查询，API 调用从 N 次降至 1 次
- **TTLCache 缓存** - 使用 `cachetools` 替代手动缓存管理，自动过期（媒体信息 1 小时，API Key 2 小时）

### 代码质量

- **TypeScript 类型安全** - 消除 12 处 `any` 类型，编译 0 错误
- **常量提取** - 新增 `constants/index.ts`，提取 20+ 处硬编码数字
- **可重用 Composable** - 新增 `useDataFetch` 统一数据获取模式

### 功能增强

- **自动刷新** - 正在播放数据每 5 秒自动刷新
- **时间显示** - 进度条下方显示播放时间（格式：`1:23:45 / 2:15:30`）

---

## v2.30.0 (2025-12-17) - 🛠️ 工具箱功能

### 新功能

- **工具箱页面** - 新增独立的工具箱页面，提供实用的维护工具
- **Item ID 替换工具** - Web 界面操作，用于处理剧集洗版后 ItemId 变化
  - 支持查询受影响的记录数和详细反馈
  - 提供 Python 命令行脚本版本（`tools/replace_item_id.py`）

---

## v2.29.2 (2025-12-17) - 🔧 代码模块化重构

### 改进

- **后端路由模块化** - 将 979 行的 `stats.py` 拆分为 8 个功能模块（overview、trend、users、content、history、favorites、filters、mappings）
- **可读性提升** - 最大文件从 978 行降至 260 行
- **API 文档优化** - 独立的路由标签，文档更清晰
- **完全向后兼容** - 所有 API 端点和响应格式保持不变

---

## v2.29.1 (2025-12-16) - ⚡ 性能优化

### 优化

- **消除代码重复** - 提取 `build_filter_conditions` 为统一工具函数，消除 113 行重复代码
- **N+1 查询优化** - 添加批量查询方法，API 调用从 40+ 次降至 1-2 次
- **性能提升 80%+** - 响应时间从 2-5秒 降至 200-500ms

---

## v2.29.0 (2025-12-16) - 📝 日志优化

### 改进

- **HTTP 请求日志中间件** - 4xx 记录为 WARNING，5xx 记录为 ERROR，2xx 成功请求静默
- **禁用 Uvicorn 访问日志** - 消除日志噪音，避免重复记录
- **API Key 验证日志优化** - Token 验证失败降级为 DEBUG 级别
- **代码质量提升** - 替换所有 print 语句为 logger（9 处）

---

## v2.28.0 (2025-12-16) - 🚀 后端架构优化

### 核心改进

- **统一日志系统** - 创建 `logger.py` 模块，替换 40+ 处 print 语句，支持日志级别控制
- **数据库连接池** - 创建 `db_pool.py` 模块，独立连接池管理，并发性能达 692 QPS
- **参数解析工具** - 创建 `utils/query_parser.py`，消除 120+ 行重复代码

---


## v2.27.0 (2025-12-15) - 🔐 登录持久化重大更新


#### 核心改进
- **会话存储方式变更** - 从内存存储迁移到 SQLite 数据库持久化
  - 会话数据保存在 `/config/sessions.db`
  - 容器重启、更新不影响登录状态
  - 支持自动迁移旧版会话表结构

- **会话有效期大幅延长** - 从 7 天延长到 **30 天**
  - 登录一次，一个月内无需重新登录
  - 显著提升用户体验

- **智能会话管理**
  - 每次访问自动更新最后活动时间（last_activity）
  - 支持会话续期机制
  - 完整的会话生命周期管理

### ✨ 新功能

- **定时清理过期会话** - 每小时自动清理过期会话
  - 防止数据库无限增长
  - 保持数据库性能

- **调试端点** - 添加 `/api/debug/scheduler` 查看调度器状态
  - 实时查看定时任务运行情况
  - 方便排查问题

### 🔧 技术改进

**会话服务 (session.py)**
- 新增 `SessionService` 类，提供完整的会话管理功能
- 支持创建、查询、删除、延期会话
- 自动检测并迁移旧版会话表
- 使用索引优化查询性能

**数据库表结构**
```sql
sessions (
  session_id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  username TEXT NOT NULL,
  is_admin INTEGER NOT NULL,
  server_id TEXT NOT NULL,
  created_at INTEGER NOT NULL,    -- 创建时间
  expires_at INTEGER NOT NULL,     -- 过期时间（新增）
  last_activity INTEGER NOT NULL   -- 最后活动时间（新增）
)
```

**认证模块优化**
- 移除内存会话存储，改用数据库服务
- Cookie 有效期与会话有效期同步（30天）
- 中间件改为异步函数，提升性能

**启动初始化**
- 应用启动时自动初始化会话数据库
- 自动清理历史过期会话
- 使用 logger 替代 print，日志更规范

### 🔒 安全性增强

- **HttpOnly Cookie** - 防止 XSS 攻击
- **SameSite=Lax** - 防止 CSRF 攻击
- **服务器端会话验证** - 双重验证机制
- **加密 Session Token** - 使用 `secrets.token_urlsafe(32)` 生成

### 📦 数据持久化

**存储位置：** `/config/sessions.db`
- 使用 Docker volume 挂载，数据永久保存
- 支持跨容器迁移
- 自动备份机制（随 config 目录）

### 🔄 向下兼容

- **自动迁移** - 智能检测旧版会话表并自动升级
- **无缝升级** - 用户更新后无需任何操作
- **数据安全** - 旧会话自动清理，新会话自动创建

### 📊 性能优化

- 会话查询使用索引，性能提升 **10倍以上**
- 异步数据库操作，不阻塞主线程
- 定时清理避免数据积累影响性能

### 🎯 用户体验提升

- ✅ **登录一次，30天免登录**
- ✅ **容器重启/更新不掉线**
- ✅ **自动清理，无需维护**
- ✅ **向下兼容，自动迁移**

### 📝 开发文档更新

- 更新 `DEVELOPMENT.md` 版本号为 v2.27.0
- 添加会话管理服务说明
- 完善数据库表结构文档

---

## v2.26.3 (2025-12-15) - 🐛 观影报告优化

### 🐛 Bug 修复
- **修复观影报告中文字体乱码问题** - 在 Docker 镜像中安装 `fonts-noto-cjk` 字体包
  - 原因：Python 3.11-slim 基础镜像不包含中文字体
  - 修复后报告中的中文文字能够正常显示

### ✨ 功能改进
- **优化观影报告字体大小** - 提升报告可读性
  - 默认缩放比例从 1.0 提升到 1.5
  - 调整各级字体大小，使文字更清晰易读

- **热门内容增加播放时长显示** - 统计信息更完整
  - 在热门内容列表中，除播放次数外，同时显示播放时长
  - 格式：`X 次播放 · Y小时Z分钟`
  - 帮助用户更全面了解内容的观看情况

### 📦 镜像更新
- 安装系统字体依赖：`fonts-noto-cjk`
- 优化镜像构建流程，清理 apt 缓存减小镜像体积

---

## v2.26 (2025-12-14) - 🎉 前端重构版本

### 🚀 重大更新

**前端技术栈全面重构** - 从 React 迁移到 Vue 3

#### 技术栈变化
- **框架**：React 19 → Vue 3.5 (Composition API)
- **UI 库**：Tailwind CSS → Vuetify 3.7 (Material Design)
- **状态管理**：React Context → Pinia 2.2
- **图表库**：Recharts → ECharts 5.5
- **路由**：React Router → Vue Router 4.5
- **构建工具**：Vite 6.0 (保持不变)

#### 为什么重构？
1. **更好的性能** - Vue 3 的响应式系统更高效，渲染速度更快
2. **更现代的 UI** - Vuetify 3 提供完整的 Material Design 组件
3. **更好的开发体验** - Composition API 代码更简洁，类型支持更好
4. **更小的包体积** - 优化后的构建产物更小
5. **更易维护** - Pinia 状态管理更直观，代码结构更清晰

#### UI/UX 改进
- **全新的 Material Design 界面** - 采用 Vuetify 组件库，视觉效果更统一
- **改进的导航体验** - 侧边栏导航更清晰，支持响应式布局
- **更流畅的动画** - Vue 的 transition 系统提供更自然的过渡效果
- **优化的图表交互** - ECharts 提供更丰富的交互选项和更好的性能
- **改进的移动端体验** - 更好的触摸交互和响应式设计

### ✨ 新功能

**报告推送测试功能** - 在报告配置页面添加测试按钮
- 位置：「报告配置」标签页，「手动发送报告」按钮旁边
- 功能：发送测试消息到配置的 Telegram，验证 Bot Token 和 Chat ID 是否正确
- 测试消息："✅ 测试消息 - Emby Stats 报告推送配置成功！可以正常发送消息。"
- 按钮在 Telegram 未启用或未配置时自动禁用
- 支持详细的错误提示，帮助快速定位配置问题

### 🔧 改进

- **性能优化** - 组件懒加载、路由懒加载、虚拟滚动优化
- **状态持久化** - 使用 Pinia Plugin Persistedstate 实现筛选状态持久化
- **类型安全** - 全面的 TypeScript 类型定义，减少运行时错误
- **代码质量** - 更清晰的代码结构和更好的可维护性
- **用户体验** - Toast 通知、确认对话框、加载状态等交互优化

### 📦 依赖更新

**新增依赖：**
- `vue@^3.5`
- `vuetify@^3.7`
- `pinia@^2.2`
- `vue-router@^4.5`
- `echarts@^5.5`
- `vue-echarts@^7.0`
- `@vueuse/core@^11.0`
- `vite-plugin-pwa@^0.19`

**移除依赖：**
- `react`
- `react-dom`
- `react-router-dom`
- `tailwindcss`
- `recharts`
- `framer-motion`

### ⚠️ 破坏性变更

**无** - 本次重构仅涉及前端，后端 API 完全兼容，用户数据和配置不受影响

### 🔄 迁移指南

**对于用户：**
- 无需任何操作，Docker 镜像更新后自动使用新前端
- 所有配置、数据、功能保持不变
- 可能需要清除浏览器缓存以加载新版本

**对于开发者：**
- 前端代码位于 `frontend-vue/` 目录
- 开发文档已更新，详见 [DEVELOPMENT.md](DEVELOPMENT.md)
- 迁移计划详见 [VUE3_MIGRATION_PLAN.md](VUE3_MIGRATION_PLAN.md)

### 🐛 修复

- 修复了 React 版本中存在的一些布局问题
- 优化了服务器切换时的数据刷新逻辑
- 改进了 PWA 的更新机制

### 📝 文档更新

- 更新了 README.md 技术栈说明
- 更新了 DEVELOPMENT.md 开发文档
- 添加了 Vue3 迁移计划文档

---

## v1.9 (2025-12-10)

### 新功能
- **收藏页面重构** - 全新的双视图收藏展示
  - **按用户视图**：展示每个用户的收藏列表，支持展开查看完整收藏
  - **热门榜单视图**：保留原有的收藏排行榜功能
  - **用户搜索**：快速搜索特定用户的收藏
  - **类型筛选**：支持按全部/电影/剧集筛选
  - 用户卡片显示收藏数量和海报预览

---

## v1.85 (2025-12-10)

### 修复
- **服务器编辑数据丢失问题** - 修复编辑服务器配置时数据库路径被清空的问题
  - 编辑服务器时只更新实际修改的字段，不再覆盖未修改的配置

---

## v1.84 (2025-12-10)

### 新功能
- **绑定用户搜索** - 在绑定用户列表中添加搜索功能
  - 支持按 Emby 用户名、Telegram 用户名、Telegram 昵称、Telegram ID 搜索
  - 快速定位特定绑定用户

---

## v1.80 (2025-12-10)

### 新功能
- **Telegram 用户绑定** - 支持 Emby 用户绑定 Telegram 账号，接收个人观影报告
  - 用户通过 Bot 发送 `/bind` 命令，输入 Emby 账号密码完成绑定
  - 绑定后自动接收个人专属的每日/每周/每月观影报告
  - 支持解绑操作

### 改进
- **Docker 日志限制** - 添加容器日志大小限制，防止日志文件过大

---

## v1.71 (2025-12-08)

### 修复
- **登录页面服务器列表问题** - 修复未登录时无法获取服务器列表的问题
  - 服务器 API 被认证中间件拦截，导致登录页面显示"未配置服务器"
  - 将 `/api/servers` 添加到公开路径，允许未认证访问

---

## v1.7 (2025-12-08)

### 新功能
- **多服务器支持** - 支持管理多个 Emby 服务器
  - 在 Web 界面添加、编辑、删除服务器配置
  - 登录时可选择要连接的服务器
  - 支持设置默认服务器
  - 旧版环境变量配置自动迁移
- **文件选择器** - 添加服务器时可通过文件浏览器选择数据库路径
  - 浏览容器内文件系统
  - 支持快捷路径跳转
  - 直接选择 .db 数据库文件

### 改进
- **界面优化** - 调整面板背景透明度，提升文字可读性

---

## v1.6 (2025-12-07)

### 改进
- **动画与UI优化** - 优化了一些动画效果与UI微调

---

## v1.57 (2025-12-06)

### 新功能
- **Telegram 代理支持** - 支持在 Web 界面配置 Telegram 推送代理
  - 支持 HTTP 代理（如 `http://127.0.0.1:7890`）
  - 支持 SOCKS5 代理（如 `socks5://127.0.0.1:1080`）
  - 在「观影报告」设置页面可直接配置

---

## v1.51 (2025-12-04)

### 改进
- **UI 优化** - 界面样式调整与改进

---

## v1.5 (2025-12-04)

### 新功能
- **观影报告推送** - 支持通过 Telegram Bot 推送观影报告
  - 三个独立定时任务：每日报告、每周报告、每月报告
  - 每个任务可单独启用/禁用，自定义 Cron 表达式
  - 支持手动触发发送，可选择发送哪个周期的报告
  - 报告内容包含：观看时长、播放次数、观看内容数、热门内容排行
  - 美化的报告图片：现代深色主题、渐变背景、海报阴影、排名颜色

### 改进
- **内容统计去重** - 观看内容数量现在按 ItemId 去重，同一集播放多次只算1个内容
- **时间范围过滤** - 报告数据严格按照时间范围过滤（今日/本周/本月）

---

## v1.4 (2025-12-04)

### 新功能
- **历史记录搜索** - 支持按内容名称搜索播放历史
  - 搜索时自动使用全库范围，不受时间筛选限制
  - 搜索结果以列表形式展示（封面 + 内容名称 + 用户 + 时间 + 播放时长 + 客户端 + 设备）
  - 正常浏览时仍使用海报网格展示
  - 搜索同样遵循 `MIN_PLAY_DURATION` 环境变量的过滤规则

---

## v1.3 (2025-12-03)

### 新功能
- **Web 界面名称映射配置** - 可直接在设置面板中配置客户端/设备名称映射
- **设置面板** - 右上角新增设置按钮，支持在线配置

### 改进
- 名称映射配置自动保存到 `/config/name_mappings.json`

---

## v1.2 (2025-12-02)

### 新功能
- **MIN_PLAY_DURATION 环境变量** - 支持过滤播放时长过短的记录
- **播放时长过滤** - 低于设定时长的记录不计入历史和统计

---

## v1.1 (2025-12-01)

### 新功能
- **名称映射** - 支持通过配置文件自定义客户端/设备显示名称
- **PWA 支持** - 可添加到手机主屏幕作为独立应用

---

## v1.0 (2025-11-30)

### 初始版本
- 实时播放监控
- 播放趋势分析
- 热门内容排行
- 用户统计
- 设备/客户端统计
- 播放历史记录
- 管理员认证登录
